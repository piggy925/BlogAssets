回归分析：研究X、Y之间的相关性

回归分析要完成的三个使命：

+ 识别重要变量
+ 判断相关性的方向
+ 估计权重（回归系数）

#### 回归分析的分类

![image-20211004201146588](https://cdn.jsdelivr.net/gh/piggy925/BlogAssets@main/uPic/mcm)

#### 数据的分类

1. **横截面数据**

*在某一时间点收集的不同对象的数据*

+ 发放问卷得到的数据
+ 全国各省份2018年GDP的数据
+ 大一新生今年体测的得到的数据

2. **时间序列数据**

*对**同一对象**在**不同时间**连续观察所取得的数据*

+ 从出生到现在，你的体重的数据(每年生日称一次)
+ 中国历年来GDP的数据
+ 在某地方每隔一小时测得的温度数据

3. **面板数据**

*横截面数据与时间序列数据综合起来的一种数据资源*

+ 2008‐2018年，我国各省份GDP的数据

#### 不同数据类型的处理方法

![image-20211004202351280](https://cdn.jsdelivr.net/gh/piggy925/BlogAssets@main/uPic/mcm-8.png)

#### 线性回归

使用线性回归模型进行建模前，需要对数据进行预处理。 用Excel、Matlab、Stata等软件都可。

**内生性：**

包含了所有与y相关，但未添加到回归模型中的变量，如果这些变量和我们已经添加的自变量相关，则存在内生性。

**核心解释变量：**

我们最感兴趣的变量，因此我们特别希望得到对其系数的 一致估计(当样本容量无限增大时，收敛于待估计参数的真值 )。

**控制变量：**

我们可能对于这些变量本身并无太大兴趣，而之所以把它们也放入回归方程，主要是为了“控制住”那些对被解释变量有影响的遗漏因素。

**在实际应用中，我们只要保证核心解释变量与误差项𝝁不相关即可。**

**虚拟变量：**

为了避免完全多重共线性的影响，引入虚拟变量的个数一般是分类数减1。

#### 在Stata中进行数据描述行统计

1. 定量数据

```stata
summarize 变量1 变量2 ... 变量n
```

如：`summarize 团购价元 评价量 商品毛重kg`

输出：

![image-20211005151609362](https://cdn.jsdelivr.net/gh/piggy925/BlogAssets@main/uPic/Math-40.png)

2. 定性数据

```stata
tabulate 变量名,gen(A)
//返回对应的这个变量的频率分布表，并生成对应的虚拟变量(以A开头)。
```

如：`tabulate 配方,gen(A)`

输出：

![image-20211005151912648](https://cdn.jsdelivr.net/gh/piggy925/BlogAssets@main/uPic/Math-41.png)

示例代码：

```stata
// 按键盘上的PageUp可以使用上一次输入的代码（Matleb中是上箭头）
// 清除所有变量
clear
// 清屏 和 matlab的clc类似
cls 
// 导入数据（其实是我们直接在界面上粘贴过来的，我们用鼠标点界面导入更方便 本条请删除后再复制到论文中，如果评委老师看到了就知道这不是你写的了）
// import excel "C:\Users\hc_lzp\Desktop\数学建模视频录制\第7讲.多元回归分析\代码和例题数据\课堂中讲解的奶粉数据.xlsx", sheet("Sheet1") firstrow
import excel "课堂中讲解的奶粉数据.xlsx", sheet("Sheet1") firstrow
// 定量变量的描述性统计
summarize 团购价元 评价量 商品毛重kg
// 定性变量的频数分布，并得到相应字母开头的虚拟变量
tabulate 配方,gen(A)
tabulate 奶源产地 ,gen(B)
tabulate 国产或进口 ,gen(C)
tabulate 适用年龄岁 ,gen(D)
tabulate 包装单位 ,gen(E)
tabulate 分类 ,gen(F)
tabulate 段位 ,gen(G)
```

3. 回归

```stata
// 下面进行回归
regress 评价量 团购价元 商品毛重kg
// 下面的语句可帮助我们把回归结果保存在Word文档中
// 在使用之前需要运行下面这个代码来安装下这个功能包（运行一次之后就可以注释掉了）
// ssc install reg2docx, all replace
// 如果安装出现connection timed out的错误，可以尝试换成手机热点联网，如果手机热点也不能下载，就不用这个命令吧，可以自己做一个回归结果表，如果觉得麻烦就直接把回归结果截图。
est store m1
reg2docx m1 using m1.docx, replace
```

#### 拟合优度较低时的处理

+ 回归分为解释型回归和预测型回归。

  预测型回归一般才会更看重𝑅2，解释型回归更多的关注模型整体显著性以及自变量的统计显著性和经济意义显著性即可。

+ 可以对模型进行调整，例如对数据**取对数**或者**平方**后再进行回归。

+ 数据中可能有存在异常值或者数据的分布极度不均匀。

#### 标准化回归

为了更为精准的研究影响评价量的重要因素(去除量纲的影响)， 可考虑使用标准化回归系数。

对数据进行标准化，就是将原始数据减去它的均数后，再除以该变量的标准差，计算得到新的变量值，新变量构成的回归方程称为标准化回归方程，回归后相应可得到标准化回归系数。

**标准化系数的绝对值越大，说明对因变量的影响就越大。**

**Stata标准化回归命令：**

```stata
regress y x1 x2 ... xk,beta
```

#### 异方差问题

横截面数据容易出现异方差的问题，时间序列数据容易出现自相关的问题。

如果扰动项存在异方差，会造成：

+ OLS（普通最小二乘）估计出来的回归系数是无偏、一致的
+ 假设检验无法使用（构造的统计量失效了）
+ OLS估计量不再是最优线性无偏估计量（BLUE）

如何解决异方差：

+ 使用OLS + 稳健的标准误（推荐）

+ 广义最小二乘估计法GLS

  原理：方差较小的数据包含的信息较多，我们可以给予信息量大的数据更大的权重(即方差较小的数据给予更大的权重)

##### 绘制残差图

```stata
//在回归结束后运行命令:
rvfplot (画残差与拟合值的散点图) 
rvpplot x (画残差与自变量x的散点图)

//保存绘制的图片
graph export a1.png ,replace
```

##### 异方差的假设检验

```stata
//异方差BP检验
estat hettest ,rhs iid

//异方差怀特检验
estat imtest,white
```

##### 使用OLS + 稳健的标准误

```stata
regress y x1 x2 ... xk,robust
```

#### 多重共线性问题

##### 检验多重共线性

一个经验规则是，如果VIF>10，则认为该回归方程存在严重的多重共线性。

```stata
//Stata计算各自变量VIF的命令(在回归结束后使用): 
estat vif
```

 <img src="https://cdn.jsdelivr.net/gh/piggy925/BlogAssets@main/uPic/image-20211006140710099.png" alt="image-20211006140710099" style="zoom: 50%;" />

##### 多重共线性的处理方式

增大样本容量 or 删除导致多重共线性的变量。

#### 逐步回归分析

*用于剔除多重共线性的影响*

##### 向前逐步回归

将自变量逐个引入模型，每引入一个自变量后都要进行检验，显著时才加入回归模型。

Stata实现代码：

```stata
stepwise regress y x1 x2 ... xk, pe(#1)
//#1表示显著性水平，一般取5%
//pe(#1) specifies the significance level for addition to the model; terms with p<#1 are eligible for addition(显著才加入模型中).
```

##### 向后逐步回归

先将所有变量均放入模型，之后尝试将其中一个自变量从模型中剔除，看整个模型解释因变量的变异是否有显著变化，之后将最没有解释力的那个自变量剔除;此过程不断迭代， 直到没有自变量符合剔除的条件。

Stata实现代码：

```stata
stepwise regress y x1 x2 ... xk, pr(#2)
//pr(#2) specifies the significance level for removal from the model; terms with p>= #2 are eligible for removal(不显著就剔除出模型).
```

> 如果你觉得筛选后的变量仍很多，你可以减小#1或者#2 
>
> 如果你觉得筛选后的变量太少了，你可以增加#1或者#2

##### 补充说明

+ 向前逐步回归和向后逐步回归的结果可能不同
+ 不要轻易使用逐步回归分析，因为剔除了自变量后很有可能会产生新的问题，例如内生性问题


